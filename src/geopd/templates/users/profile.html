{% extends "base.html" %}

{% block content %}
    <div class="container-fluid">

        <div class="row">
            <div class="col-md-8 col-md-offset-2">
                <ol class="breadcrumb">
                    <li><a href="{{ url_for('web.show_users') }}">Members</a></li>
                    <li>{{ user.name }}</li>
                </ol>
            </div>
        </div>

        <div class="row">
            <div class="col-md-offset-2 col-md-8">
                <div id="kv-avatar-errors" class="center-block"></div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-2 col-md-offset-2 col-sm-12 col-xs-12">
                {% if current_user.id == user.id %}
                    <div class="kv-avatar text-center">
                        <input id="avatar" name="avatar" type="file" class="file-loading center-block">
                    </div>
                {% else %}
                    <img src="{{ url_for('web.get_user_avatar', id=user.id) }}" alt="{{ user.name }}"
                         class="img-rounded img-responsive thumbnail center-block"/>
                {% endif %}
            </div>
            <div class="col-md-6 col-sm-12 col-xs-12">
                <br class="visible-sm visible-xs"/>
                <h2>{{ user.name }}</h2>
                <p class="text-muted">
                    <span class="glyphicon glyphicon-map-marker"></span>
                    {{ user.address.institution }}<br/>
                    <small><em>{{ user.address }}</em></small>
                </p>
                <p>
                    <i class="glyphicon glyphicon-envelope"></i>
                    <a href="mailto:{{ user.email }}?Subject=[GEoPD]%20" target="_top">{{ user.email }}</a>
                </p>
                <p class="text-muted">Member since
                    <time class="moment">{{ user.created_on|datetime }}</time>
                    .
                    {% if user.last_seen %}
                        Last Seen
                        <time class="moment">{{ user.last_seen|datetime }}</time>
                        .
                    {% endif %}
                </p>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8 col-md-offset-2 col-sm-12 col-xs-12">

                <hr/>

                <ul class="nav nav-tabs">
                    <li class="active"><a data-toggle="tab" href="#biography-pane">Biography</a></li>
                    {% if user.id == current_user.id %}
                        <li><a data-toggle="tab" href="#address-pane">Address</a></li>
                    {% endif %}
                    <li><a data-toggle="tab" href="#survey-pane">Survey</a></li>
                </ul>

                <div class="tab-content">

                    <!-- Biography //-->
                    <div id="biography-pane" class="tab-pane fade in active">
                        <h3 class="page-header text-primary">Research Interests</h3>
                        <p class="edit edit-biography" id="interest">
                            {%- if user.bio.research_interests -%}
                                {{ user.bio.research_interests }}
                            {%- elif current_user.id != user.id -%}
                                No research interests provided.
                            {%- endif -%}
                        </p>
                        <h3 class="page-header text-primary">Research Experience</h3>
                        <p class="edit edit-biography" id="experience">
                            {%- if user.bio.research_experience -%}
                                {{ user.bio.research_experience }}
                            {%- elif current_user.id != user.id -%}
                                No research experience provided.
                            {%- endif -%}
                        </p>
                    </div>


                    <!-- Address //-->
                    {% if user.id == current_user.id %}
                    <div id="address-pane" class="tab-pane fade">
                        <form action="{{ url_for('web.update_user_address', id=current_user.id) }}" method="post">
                            {{ address_form.csrf_token }}
                            <div class="form-group">
                                <div class="input-group">
                                    <span class="input-group-addon">
                                        <span class="glyphicon glyphicon-home"></span>
                                    </span>
                                    <input class="form-control" autocomplete="off"
                                           id="{{ address_form.location.id }}" ,
                                           name="{{ address_form.location.name }}" ,
                                           placeholder="{{ address_form.location.label.text }}"
                                           required="required">
                                    {{ address_form.institution }}
                                    {{ address_form.lng }}
                                    {{ address_form.lat }}
                                </div>
                                <div class="help-block with-errors"></div>
                            </div>

                            <div id="address" class="collapse">

                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="input-group">
                                                <span class="input-group-addon">{{ address_form.street.label.text }}</span>
                                                {{ address_form.street(class='form-control', readonly='readonly') }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="input-group">
                                                <span class="input-group-addon">{{ address_form.city.label.text }}</span>
                                                {{ address_form.city(class='form-control', readonly='readonly') }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="input-group">
                                                <span class="input-group-addon">{{ address_form.region.label.text }}</span>
                                                {{ address_form.region(class='form-control', readonly='readonly') }}
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="input-group">
                                                <span class="input-group-addon">{{ address_form.postal.label.text }}</span>
                                                {{ address_form.postal(class='form-control', readonly='readonly') }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="input-group">
                                                <span class="input-group-addon">{{ address_form.country.label.text }}</span>
                                                {{ address_form.country(class='form-control', readonly='readonly') }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                {{ address_form.submit(class="btn btn-primary") }}
                            </div>
                        </form>
                    </div>
                    {% endif %}

                    <!-- Survey //-->
                    <div id="survey-pane" class="tab-pane fade">

                        <div class="row">
                            <div class="col-md-12">
                                <p class="help-block">
                                    In order to best serve your interests and those of the general usership, please
                                    spend a minute completing the following questionnaire. Briefly, we seek to learn
                                    what clinical tools you use, what epidemiologic exposures you measure, and what
                                    types of biospecimens you currently have.
                                </p>
                            </div>
                        </div>

                        <div class="row">

                            <div class="col-md-4">
                                <h3 class="page-header text-primary">Clinical Information</h3>
                                {% if current_user.id == user.id %}
                                    <p class="text-muted">&#x2714 Check all that apply.</p>
                                {% endif %}
                                <div class="funkyradio">
                                    {% for c in clinical %}
                                        <div class="funkyradio-primary">
                                            <input type="checkbox" name="clinical" id="clinical-{{ c.id }}"
                                                   value="{{ c.id }}"
                                                   {% if c in user.survey.clinical %}checked="checked"{% endif %}/>
                                            <label for="clinical-{{ c.id }}">{{ c.name }}</label>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="col-md-4">
                                <h3 class="page-header text-primary">Epidemiologic Exposures</h3>
                                {% if current_user.id == user.id %}
                                    <p class="text-muted">&#x2714 Check all that apply.</p>
                                {% endif %}
                                <div class="funkyradio">
                                    {% for c in epidemiologic %}
                                        <div class="funkyradio-primary">
                                            <input type="checkbox" name="epidemiologic" id="epidemiologic-{{ c.id }}"
                                                   value="{{ c.id }}"
                                                   {% if c in user.survey.epidemiologic %}checked="checked"{% endif %}/>
                                            <label for="epidemiologic-{{ c.id }}">{{ c.name }}</label>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="col-md-4">
                                <h3 class="page-header text-primary">Biospecimens</h3>
                                {% if current_user.id == user.id %}
                                    <p class="text-muted">&#x2714 Check all that apply.</p>
                                {% endif %}
                                <div class="funkyradio">
                                    {% for c in biospecimen %}
                                        <div class="funkyradio-primary">
                                            <input type="checkbox" name="biospecimen" id="biospecimen-{{ c.id }}"
                                                   value="{{ c.id }}"
                                                   {% if c in user.survey.biospecimen %}checked="checked"{% endif %}/>
                                            <label for="biospecimen-{{ c.id }}">{{ c.name }}</label>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>

                        </div>


                        <h4 class="page-header text-primary">
                            Was your study approved by an ethical committee?
                        </h4>
                        <div class="funkyradio explain">
                            <div class="funkyradio-primary">
                                <input type="radio" name="ethical" id="ethical-yes" value="yes"
                                       {% if user.survey.ethical == true %}checked="checked"{% endif %}/>
                                <label for="ethical-yes">Yes</label>
                            </div>
                            <div class="funkyradio-primary">
                                <input type="radio" name="ethical" id="ethical-no" value="no"
                                       {% if user.survey.ethical == false %}checked="checked"{% endif %}/>
                                <label for="ethical-no">No</label>
                            </div>
                            <div class="collapse {% if user.survey.ethical == False %}in{% endif %}"
                                 id="ethical-explanation">
                                <h5 class="text-primary">Explanation</h5>
                                <p id="ethical-explain" class="edit edit-explain">
                                    {{ user.survey.ethical_explain if user.survey.ethical_explain }}
                                </p>
                            </div>
                        </div>

                        <h4 class="page-header text-primary">
                            Did the participants sign an informed consent form?
                        </h4>
                        <div class="funkyradio explain">
                            <div class="funkyradio-primary">
                                <input type="radio" name="consent" id="consent-yes" value="yes"
                                       {% if user.survey.consent == true %}checked="checked"{% endif %}/>
                                <label for="consent-yes">Yes</label>
                            </div>
                            <div class="funkyradio-primary explain">
                                <input type="radio" name="consent" id="consent-no" value="no"
                                       {% if user.survey.consent == false %}checked="checked"{% endif %}/>
                                <label for="consent-no">No</label>
                            </div>
                            <div class="collapse {% if user.survey.consent == False %}in{% endif %}"
                                 id="consent-explanation">
                                <h5 class="text-primary">Explanation</h5>
                                <p id="consent-explain" class="edit edit-explain">
                                    {{ user.survey.consent_explain if user.survey.consent_explain }}
                                </p>
                            </div>
                        </div>

                        <div id="sharing" class="collapse {% if user.survey.consent == True %}in{% endif %}">
                            <h4 class="page-header text-primary">
                                Does the informed consent permit sharing of de-identified data & DNA samples?
                            </h4>
                            <div class="funkyradio">
                                <div class="funkyradio-primary">
                                    <input type="radio" name="sharing" id="sharing-yes" value="yes"
                                           {% if user.survey.sharing == true %}checked="checked"{% endif %}/>
                                    <label for="sharing-yes">Yes</label>
                                </div>
                                <div class="funkyradio-primary">
                                    <input type="radio" name="sharing" id="sharing-no" value="no"
                                           {% if user.survey.sharing == false %}checked="checked"{% endif %}/>
                                    <label for="sharing-no">No</label>
                                </div>
                            </div>
                        </div>

                        <h4 class="page-header text-primary">
                            Are you willing to send (to a centralized laboratory) a small number of DNA samples to
                            assess genotyping accuracy?
                        </h4>
                        <div class="funkyradio">
                            <div class="funkyradio-primary">
                                <input type="radio" name="sample" id="sample-yes" value="yes"
                                       {% if user.survey.sample == true %}checked="checked"{% endif %}/>
                                <label for="sample-yes">Yes</label>
                            </div>
                            <div class="funkyradio-primary">
                                <input type="radio" name="sample" id="sample-no" value="no"
                                       {% if user.survey.sample == false %}checked="checked"{% endif %}/>
                                <label for="sample-no">No</label>
                            </div>
                        </div>

                        {% if user.id == current_user.id and not user.survey.completed_on %}
                            <h4 class="page-header text-primary">Complete Survey</h4>
                            <p>
                            <form action="{{ url_for('web.update_user_survey', id=current_user.id) }}" method="post">
                                {{ survey_form.csrf_token }}
                                {{ survey_form.submit(class="btn btn-primary") }}
                            </form>
                            </p>
                        {% endif %}

                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}


{% block scripts %}
    {{ super() }}

    {% if current_user.id == user.id %}
        <script>

            var autocomplete;
            var componentMap = {
                premise: 'institution',
                locality: 'city',
                administrative_area_level_3: 'city',
                country: 'country',
                administrative_area_level_1: 'region',
                street_number: 'street',
                route: 'route',
                postal_code: 'postal',
                postal_code_prefix: 'postal'
            }

            var address = {};

            function initAutocomplete() {
                // create the autocomplete object (restrict search to geographical location)
                autocomplete = new google.maps.places.Autocomplete(document.getElementById('location'), {
                    types: ['geocode']
                });
                autocomplete.addListener('place_changed', fillInAddress);
            }

            function fillInAddress() {
                // Get the place details from the autocomplete object.
                var place = autocomplete.getPlace();
                $('#lat').val(place.geometry.location.lat());
                $('#lng').val(place.geometry.location.lng());
                $.each(place.address_components, function (i, component) {
                    if (component.types[0] in componentMap) {
                        address[componentMap[component.types[0]]] = component.long_name;
                    }
                });

                if (address.street && address.route) {
                    address.street += ' ' + address.route
                }

                if ('name' in place.html_attributions) {
                    address['institution'] = place.html_attributions.name
                }

                $.each(address, function (key, value) {
                    $('#' + key).val(value);
                });
                $('#address').collapse('show');
            }

            $(document).ready(function () {

                var info_update_url = '{{ url_for('ajax.update_user_info', id=current_user.id) }}';

                $('#survey input[type=checkbox], #survey input[type=radio]').click(function (e) {
                    $.post(info_update_url, {
                        'name': $(e.target).attr('name'),
                        'value': $(e.target).attr('value'),
                        'checked': (e.target.checked) ? 'yes' : 'no',
                    }).fail(function () {
                        alert('Error encountered while updating your profile. Please try again later');
                    });
                });

                $('.edit-biography').editable(info_update_url, {
                    type: 'textarea',
                    rows: 10,
                });

                $('.explain').each(function (i, explain) {
                    var editable = $(explain).find('p.edit-explain').editable(info_update_url, {
                        type: 'textarea',
                        rows: 3,
                    });
                    $(explain).find('input[type=radio]').click(function (e) {
                        if (e.target.value == 'no') {
                            $(explain).find('.collapse').collapse('show');
                        } else {
                            $(explain).find('.collapse').collapse('hide');
                        }
                    });
                });

                $('#consent-yes').click(function () {
                    $('#sharing').collapse('show');
                });

                $('#consent-no').click(function () {
                    $('#sharing').collapse('hide');
                });

                $("#avatar").fileinput({
                    uploadUrl: "{{ url_for('ajax.update_user_info', id=current_user.id) }}",
                    uploadAsync: true,
                    uploadExtraData: {
                        name: 'avatar'
                    },
                    overwriteInitial: true,
                    maxFileSize: 1500,

                    showClose: false,
                    showCaption: false,
                    browseLabel: '',
                    removeLabel: '',
                    uploadLabel: 'Save',
                    browseIcon: '<i class="glyphicon glyphicon-pencil"></i>',
                    removeIcon: '<i class="glyphicon glyphicon-remove-circle"></i>',
                    removeTitle: 'Cancel or reset changes',
                    browseClass: 'btn btn-primary btn-sm',
                    removeClass: 'btn btn-default btn-sm',
                    uploadClass: 'btn btn-default btn-sm',

                    elErrorContainer: '#kv-avatar-errors',
                    msgErrorClass: 'alert alert-block alert-danger',
                    defaultPreviewContent: geopd.dom.html($('<img/>').addClass('file-preview-image')
                            .attr('alt', "{{ user.name }}")
                            .attr('title', "{{ user.name }}")
                            .attr('src', "{{ url_for('web.get_user_avatar', id=current_user.id) }}")),
                    removeFromPreviewOnError: true,
                    allowedFileExtensions: ["jpg", "jpeg", "png", "gif"],
                    layoutTemplates: {
                        footer: '',
                        main2: '{preview}\n<div class="kv-upload-progress hide"></div>\n{remove}\n{upload}\n{browse}\n',
                    },
                });


            });
        </script>
        <script src="{{ geopd.get('google.api', 'map_url') }}?key={{ geopd.get('google.api', 'key') }}&libraries=places&callback=initAutocomplete"
                async defer></script>

    {% else %}

        <script>
            $(document).ready(function () {
                $('#survey input[type=checkbox], #survey input[type=radio]').prop('disabled', true);
            });
        </script>

    {% endif %}

{% endblock %}