{% extends "base.html" %}

{% block content %}
    <div class="container-fluid">

        <div class="row">
            <div class="col-md-8 col-md-offset-2">
                <ol class="breadcrumb">
                    <li><a href="{{ url_for('web.show_members') }}">Members</a></li>
                    <li>{{ member.name }}</li>
                </ol>
            </div>
        </div>

        <div class="row">
            <div class="col-md-offset-2 col-md-8">
                <div id="kv-avatar-errors" class="center-block"></div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-2 col-md-offset-2 col-sm-12 col-xs-12">
                {% if current_user.id == member.id %}
                    <div class="kv-avatar text-center">
                        <input id="avatar" name="avatar" type="file" class="file-loading center-block">
                    </div>
                {% else %}
                    <img src="{{ url_for('web.get_member_avatar', id=member.id) }}" alt="{{ member.name }}"
                         class="img-rounded img-responsive thumbnail center-block"/>
                {% endif %}
            </div>
            <div class="col-md-6 col-sm-12 col-xs-12">
                <br class="visible-sm visible-xs"/>
                <h2>{{ member.name }}</h2>
                <p class="text-muted">{{ member.institution.name }}<br/>
                    <small>
                        <span class="glyphicon glyphicon-map-marker"></span>
                        <em>{{ member.institution.city }}</em>
                    </small>
                </p>
                <p>
                    <i class="glyphicon glyphicon-envelope"></i>
                    <a href="mailto:{{ member.email }}?Subject=[GEoPD]%20" target="_top">{{ member.email }}</a>
                </p>
                <p class="text-muted">Member since
                    <time class="moment">{{ member.created_on|datetime }}</time>
                    .
                    {% if member.last_seen %}
                        Last Seen
                        <time class="moment">{{ member.last_seen|datetime }}</time>
                        .
                    {% endif %}
                </p>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8 col-md-offset-2 col-sm-12 col-xs-12">

                <hr/>

                <ul class="nav nav-tabs">
                    <li class="active"><a data-toggle="tab" href="#biography">Biography</a></li>
                    <li><a data-toggle="tab" href="#survey">Survey</a></li>
                </ul>

                <div class="tab-content">

                    <!-- Biography //-->
                    <div id="biography" class="tab-pane fade in active">
                        <h3 class="page-header text-primary">Research Interests</h3>
                        <p class="edit edit-biography" id="interest">
                            {%- if member.info.research_interests -%}
                                {{ member.info.research_interests }}
                            {%- elif current_user.id != member.id -%}
                                No research interests provided.
                            {%- endif -%}
                        </p>
                        <h3 class="page-header text-primary">Research Experience</h3>
                        <p class="edit edit-biography" id="experience">
                            {%- if member.info.research_experience -%}
                                {{ member.info.research_experience }}
                            {%- elif current_user.id != member.id -%}
                                No research experience provided.
                            {%- endif -%}
                        </p>


                    </div>

                    <!-- Survey //-->
                    <div id="survey" class="tab-pane fade">

                        <div class="row">
                            <div class="col-md-12">
                                <p class="help-block">
                                    In order to best serve your interests and those of the general membership, please
                                    spend a minute completing the following questionnaire. Briefly, we seek to learn
                                    what clinical tools you use, what epidemiologic exposures you measure, and what
                                    types of biospecimens you currently have.
                                </p>
                            </div>
                        </div>

                        <div class="row">

                            <div class="col-md-4">
                                <h3 class="page-header text-primary">Clinical Information</h3>
                                {% if current_user.id == member.id %}
                                    <p class="text-muted">&#x2714 Check all that apply.</p>
                                {% endif %}
                                <div class="funkyradio">
                                    {% for c in clinical %}
                                        <div class="funkyradio-primary">
                                            <input type="checkbox" name="clinical" id="clinical-{{ c.id }}"
                                                   value="{{ c.id }}"
                                                   {% if c in member.info.clinical %}checked="checked"{% endif %}/>
                                            <label for="clinical-{{ c.id }}">{{ c.name }}</label>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="col-md-4">
                                <h3 class="page-header text-primary">Epidemiologic Exposures</h3>
                                {% if current_user.id == member.id %}
                                    <p class="text-muted">&#x2714 Check all that apply.</p>
                                {% endif %}
                                <div class="funkyradio">
                                    {% for c in epidemiologic %}
                                        <div class="funkyradio-primary">
                                            <input type="checkbox" name="epidemiologic" id="epidemiologic-{{ c.id }}"
                                                   value="{{ c.id }}"
                                                   {% if c in member.info.epidemiologic %}checked="checked"{% endif %}/>
                                            <label for="epidemiologic-{{ c.id }}">{{ c.name }}</label>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="col-md-4">
                                <h3 class="page-header text-primary">Biospecimens</h3>
                                {% if current_user.id == member.id %}
                                    <p class="text-muted">&#x2714 Check all that apply.</p>
                                {% endif %}
                                <div class="funkyradio">
                                    {% for c in biospecimen %}
                                        <div class="funkyradio-primary">
                                            <input type="checkbox" name="biospecimen" id="biospecimen-{{ c.id }}"
                                                   value="{{ c.id }}"
                                                   {% if c in member.info.biospecimen %}checked="checked"{% endif %}/>
                                            <label for="biospecimen-{{ c.id }}">{{ c.name }}</label>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>

                        </div>


                        <h4 class="page-header text-primary">
                            Was your study approved by an ethical committee?
                        </h4>
                        <div class="funkyradio explain">
                            <div class="funkyradio-primary">
                                <input type="radio" name="ethical" id="ethical-yes" value="yes"
                                       {% if member.info.ethical == true %}checked="checked"{% endif %}/>
                                <label for="ethical-yes">Yes</label>
                            </div>
                            <div class="funkyradio-primary">
                                <input type="radio" name="ethical" id="ethical-no" value="no"
                                       {% if member.info.ethical == false %}checked="checked"{% endif %}/>
                                <label for="ethical-no">No</label>
                            </div>
                            <div class="collapse {% if member.info.ethical == False %}in{% endif %}"
                                 id="ethical-explanation">
                                <h5 class="text-primary">Explanation</h5>
                                <p id="ethical-explain" class="edit edit-explain">
                                    {{ member.info.ethical_explain if member.info.ethical_explain }}
                                </p>
                            </div>
                        </div>

                        <h4 class="page-header text-primary">
                            Did the participants sign an informed consent form?
                        </h4>
                        <div class="funkyradio explain">
                            <div class="funkyradio-primary">
                                <input type="radio" name="consent" id="consent-yes" value="yes"
                                       {% if member.info.consent == true %}checked="checked"{% endif %}/>
                                <label for="consent-yes">Yes</label>
                            </div>
                            <div class="funkyradio-primary explain">
                                <input type="radio" name="consent" id="consent-no" value="no"
                                       {% if member.info.consent == false %}checked="checked"{% endif %}/>
                                <label for="consent-no">No</label>
                            </div>
                            <div class="collapse {% if member.info.consent == False %}in{% endif %}"
                                 id="consent-explanation">
                                <h5 class="text-primary">Explanation</h5>
                                <p id="consent-explain" class="edit edit-explain">
                                    {{ member.info.consent_explain if member.info.consent_explain }}
                                </p>
                            </div>
                        </div>

                        <div id="sharing" class="collapse {% if member.info.consent == True %}in{% endif %}">
                            <h4 class="page-header text-primary">
                                Does the informed consent permit sharing of de-identified data & DNA samples?
                            </h4>
                            <div class="funkyradio">
                                <div class="funkyradio-primary">
                                    <input type="radio" name="sharing" id="sharing-yes" value="yes"
                                           {% if member.info.sharing == true %}checked="checked"{% endif %}/>
                                    <label for="sharing-yes">Yes</label>
                                </div>
                                <div class="funkyradio-primary">
                                    <input type="radio" name="sharing" id="sharing-no" value="no"
                                           {% if member.info.sharing == false %}checked="checked"{% endif %}/>
                                    <label for="sharing-no">No</label>
                                </div>
                            </div>
                        </div>

                        <h4 class="page-header text-primary">
                            Are you willing to send (to a centralized laboratory) a small number of DNA samples to
                            assess genotyping accuracy?
                        </h4>
                        <div class="funkyradio">
                            <div class="funkyradio-primary">
                                <input type="radio" name="sample" id="sample-yes" value="yes"
                                       {% if member.info.sample == true %}checked="checked"{% endif %}/>
                                <label for="sample-yes">Yes</label>
                            </div>
                            <div class="funkyradio-primary">
                                <input type="radio" name="sample" id="sample-no" value="no"
                                       {% if member.info.sample == false %}checked="checked"{% endif %}/>
                                <label for="sample-no">No</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        $(document).ready(function () {

            {% if current_user.id == member.id %}

                var info_update_url = '{{ url_for('ajax.update_member_info', id=current_user.id) }}';

                $('#survey input[type=checkbox], #survey input[type=radio]').click(function (e) {
                    $.post(info_update_url, {
                        'name': $(e.target).attr('name'),
                        'value': $(e.target).attr('value'),
                        'checked': (e.target.checked) ? 'yes' : 'no',
                    }).fail(function () {
                        alert('Error encountered while updating your profile. Please try again later');
                    });
                });

                $('.edit-biography').editable(info_update_url, {
                    type: 'textarea',
                    rows: 10,
                });

                $('.explain').each(function (i, explain) {
                    var editable = $(explain).find('p.edit-explain').editable(info_update_url, {
                        type: 'textarea',
                        rows: 3,
                    });
                    $(explain).find('input[type=radio]').click(function (e) {
                        if (e.target.value == 'no') {
                            $(explain).find('.collapse').collapse('show');
                        } else {
                            $(explain).find('.collapse').collapse('hide');
                        }
                    });
                });

                $('#consent-yes').click(function () {
                    $('#sharing').collapse('show');
                });

                $('#consent-no').click(function () {
                    $('#sharing').collapse('hide');
                });

                $("#avatar").fileinput({
                    uploadUrl: "{{ url_for('ajax.update_member_info', id=current_user.id) }}",
                    uploadAsync: true,
                    uploadExtraData: {
                        name: 'avatar'
                    },
                    overwriteInitial: true,
                    maxFileSize: 1500,

                    showClose: false,
                    showCaption: false,
                    browseLabel: '',
                    removeLabel: '',
                    uploadLabel: 'Save',
                    browseIcon: '<i class="glyphicon glyphicon-pencil"></i>',
                    removeIcon: '<i class="glyphicon glyphicon-remove-circle"></i>',
                    removeTitle: 'Cancel or reset changes',
                    browseClass: 'btn btn-primary btn-sm',
                    removeClass: 'btn btn-default btn-sm',
                    uploadClass: 'btn btn-default btn-sm',

                    elErrorContainer: '#kv-avatar-errors',
                    msgErrorClass: 'alert alert-block alert-danger',
                    defaultPreviewContent: geopd.dom.html($('<img/>').addClass('file-preview-image')
                            .attr('alt', "{{ member.name }}")
                            .attr('title', "{{ member.name }}")
                            .attr('src', "{{ url_for('web.get_member_avatar', id=current_user.id) }}")),
                    removeFromPreviewOnError: true,
                    allowedFileExtensions: ["jpg", "jpeg", "png", "gif"],
                    layoutTemplates: {
                        footer: '',
                        main2: '{preview}\n<div class="kv-upload-progress hide"></div>\n{remove}\n{upload}\n{browse}\n',
                    },
                });

            {% else %}
                $('#survey input[type=checkbox], #survey input[type=radio]').prop('disabled', true);
            {% endif %}
        });
    </script>
{% endblock %}